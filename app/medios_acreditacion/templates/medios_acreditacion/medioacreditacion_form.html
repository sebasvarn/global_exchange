
{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container mt-4">
    {% if form.errors %}
    <div id="error-box" class="alert alert-danger" style="background:var(--cui-danger-bg-subtle); border:2px solid var(--cui-danger); color:var(--cui-danger); padding:16px; border-radius:8px; margin-bottom:20px;">
        <strong><i class="bi bi-exclamation-triangle-fill me-2"></i>Por favor corrige los siguientes errores:</strong>
        <ul class="mb-0" style="margin-top:10px;">
        {% for field, errors in form.errors.items %}
            {% for error in errors %}
                <li><strong>
                    {% if field == 'tipo_medio' %}Tipo de Medio de Acreditación
                    {% elif field == 'titular_cuenta' %}Nombre del titular
                    {% elif field == 'tipo_cuenta' %}Tipo de cuenta
                    {% elif field == 'banco' %}Banco
                    {% elif field == 'numero_cuenta' %}Número de cuenta o IBAN
                    {% elif field == 'proveedor_billetera' %}Proveedor
                    {% elif field == 'billetera_email_telefono' %}Email o teléfono asociado
                    {% elif field == 'billetera_titular' %}Nombre del titular (opcional)
                    {% else %}{{ field|capfirst }}
                    {% endif %}
                :</strong> {{ error }}</li>
            {% endfor %}
        {% endfor %}
        {% if form.non_field_errors %}
            {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
            {% endfor %}
        {% endif %}
        </ul>
    </div>
    {% endif %}

    {% if cliente is None %}
        <div class="alert alert-warning">
            <strong>Atención:</strong> No se pudo asociar el cliente. El registro no se guardará.<br>
            Verifica que el parámetro <code>?cliente=ID</code> esté presente en la URL y que el usuario esté vinculado al cliente.
        </div>
    {% endif %}

    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0">
                <i class="bi bi-{% if medio %}pencil-square{% else %}plus-circle{% endif %} me-2"></i>
                {% if medio %}Editar{% else %}Nuevo{% endif %} Método de Acreditación
            </h2>
        </div>
        <div class="card-body">
            <form method="post" id="medioacreditacion-form">
                {% csrf_token %}
                {% if cliente %}
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-person-fill me-1"></i>Cliente
                        </label>
                        <input type="text" class="form-control" value="{{ cliente.nombre }}" readonly>
                        <input type="hidden" name="cliente_id" value="{{ cliente.id }}">
                    </div>
                {% endif %}

                <div class="mb-4">
                    <label for="id_tipo_medio" class="form-label fw-bold">
                        <i class="bi bi-credit-card-2-front me-1"></i>Tipo de Medio de Acreditación
                        <span class="text-danger">*</span>
                    </label>
                    {% if medio %}
                        <input type="text" class="form-control" readonly value="{{ medio.get_tipo_medio_display }}">
                        <input type="hidden" name="tipo_medio" value="{{ form.tipo_medio.value }}">
                    {% else %}
                        {{ form.tipo_medio }}
                    {% endif %}
                </div>

                <!-- CAMPOS CUENTA BANCARIA -->
                <div id="campos-cuenta" style="display:none;">
                    <div class="card mb-3 border-success">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-bank me-2"></i>Datos de la Cuenta Bancaria</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">
                                    Nombre del titular <span class="text-danger">*</span>
                                </label>
                                {{ form.titular_cuenta }}
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">
                                        Tipo de cuenta <span class="text-danger">*</span>
                                    </label>
                                    {{ form.tipo_cuenta }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">
                                        Banco <span class="text-danger">*</span>
                                    </label>
                                    {{ form.banco }}
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">
                                    Número de cuenta o IBAN <span class="text-danger">*</span>
                                </label>
                                {{ form.numero_cuenta }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CAMPOS BILLETERA DIGITAL -->
                <div id="campos-billetera" style="display:none;">
                    <div class="card mb-3 border-info">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-wallet2 me-2"></i>Datos de la Billetera Digital</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">
                                    Proveedor <span class="text-danger">*</span>
                                </label>
                                {{ form.proveedor_billetera }}
                                <small class="form-text text-muted">Ej: PayPal, Giros Tigo, Billetera Personal</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">
                                    Email o teléfono asociado <span class="text-danger">*</span>
                                </label>
                                {{ form.billetera_email_telefono }}
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">
                                    Nombre del titular <small class="text-muted">(opcional)</small>
                                </label>
                                {{ form.billetera_titular }}
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <!-- BOTONES -->
                <div class="d-flex gap-2 justify-content-end">
                    <a href="{% url 'medios_acreditacion:medios_by_client' %}" class="btn btn-secondary">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </a>
                    {% if not medio %}
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle me-1"></i>Guardar
                        </button>
                    {% elif medio %}
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle me-1"></i>Guardar Cambios
                        </button>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
</div>

<script src="{% static 'medios_acreditacion/medioacreditacion_form.js' %}"></script>

<style>
    .form-control, .form-select {
        border-radius: 0.375rem;
        border: 1px solid #ced4da;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    .form-control:focus, .form-select:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    .form-text {
        display: block;
        margin-top: 0.25rem;
        font-size: 0.875rem;
    }
    .card {
        border-radius: 0.5rem;
    }
    .card-header {
        border-top-left-radius: 0.5rem;
        border-top-right-radius: 0.5rem;
    }
    .btn {
        padding: 0.5rem 1.5rem;
        font-weight: 500;
    }
    .text-danger {
        color: #dc3545 !important;
    }
    .fw-semibold {
        font-weight: 600 !important;
    }
    #medioacreditacion-form input[type="text"],
    #medioacreditacion-form input[type="number"],
    #medioacreditacion-form input[type="email"],
    #medioacreditacion-form input[type="date"],
    #medioacreditacion-form textarea,
    #medioacreditacion-form select {
        width: 100%;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        line-height: 1.5;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
    }
</style>
{% endblock %}
